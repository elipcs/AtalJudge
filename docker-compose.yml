services:

  backend-db:
    image: postgres:13-alpine
    environment:
      - POSTGRES_USER=${DB_USERNAME:-ataljudge}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-ataljudge_password}
      - POSTGRES_DB=${DB_DATABASE:-ataljudge}
    volumes:
      - backend-db-data:/var/lib/postgresql/data
    restart: always
    mem_limit: 512m
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME:-ataljudge}" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  backend-redis:
    image: redis:6-alpine
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --requirepass
      - "${REDIS_PASSWORD:-}"
    volumes:
      - backend-redis-data:/data
    restart: always
    mem_limit: 256m
    healthcheck:
      test: [ "CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-}", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3333:3333"
    environment:
      - PORT=3333
      - NODE_ENV=production
      - DB_HOST=${DB_HOST:-backend-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME:-ataljudge}
      - DB_PASSWORD=${DB_PASSWORD:-ataljudge_password}
      - DB_DATABASE=${DB_DATABASE:-ataljudge}
      - SECRET_KEY=${SECRET_KEY:-change_this_secret_key_in_production}
      - JWT_SECRET=${JWT_SECRET:-change_this_jwt_secret_in_production}
      - REDIS_HOST=${REDIS_HOST:-backend-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

    depends_on:
      backend-db:
        condition: service_healthy
      backend-redis:
        condition: service_healthy
      judge0-server:
        condition: service_started
    restart: always
    mem_limit: 512m
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3333/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/ataljudge-executions:/tmp/ataljudge-executions

  judge0-server:
    image: judge0/judge0:1.13.1
    volumes:
      - ./judge0.conf:/judge0.conf:ro
    ports:
      - "2358:2358"
    privileged: true
    environment:
      - REDIS_HOST=judge0-redis
      - REDIS_PASSWORD=${JUDGE0_REDIS_PASSWORD:-judge0redis}
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0password}
      - POSTGRES_DB=${JUDGE0_DB_NAME:-judge0}
      - POSTGRES_HOST=judge0-db
    depends_on:
      - judge0-db
      - judge0-redis
    restart: always

  judge0-worker:
    image: judge0/judge0:1.13.1
    command: [ "./scripts/workers" ]
    volumes:
      - ./judge0.conf:/judge0.conf:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    privileged: true
    cgroupns: host
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    environment:
      - REDIS_HOST=judge0-redis
      - REDIS_PASSWORD=${JUDGE0_REDIS_PASSWORD:-judge0redis}
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0password}
      - POSTGRES_DB=${JUDGE0_DB_NAME:-judge0}
      - POSTGRES_HOST=judge0-db
    depends_on:
      - judge0-db
      - judge0-redis
    restart: always

  judge0-db:
    image: postgres:13-alpine
    environment:
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0password}
      - POSTGRES_DB=${JUDGE0_DB_NAME:-judge0}
    volumes:
      - /data/ataljudge/judge0-db:/var/lib/postgresql/data
    restart: always

  judge0-redis:
    image: redis:6-alpine
    command: [ "redis-server", "--requirepass", "${JUDGE0_REDIS_PASSWORD:-judge0redis}" ]
    volumes:
      - /data/ataljudge/judge0-redis:/data
    restart: always

volumes:
  backend-db-data:
  backend-redis-data:
  judge0-db-data:
  judge0-redis-data:
